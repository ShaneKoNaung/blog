[
  {
    "objectID": "posts/mlflow/experiment_tracking.html",
    "href": "posts/mlflow/experiment_tracking.html",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "In this tutorial, we are going to train a simple regression model. While training a model, we are going to use an experiment tracking tool called mlflow.\nWhat is mlflow?\nMLflow is a open-source experiment tracking tool. We can use mlflow to track experiments, experiment runs, artifacts related to experiment runs. MLflow has five components:\n- MLflow Tracking\n- MLflow Models\n- MLflow Model Registry\n- MLflow Projects\n- MLflow Recipes\nWe are only going to use Tracking, Models and Model Registry here. You can see the rest here in the mlflow docs.\nThis blog or notebook is the notes for week 2 ( experiment tracking ) lectures of the datatalks mlops zoomcamp.\n\n\nWe can install mlflow using pip or conda.\n\n# !pip install mlflow \n\n# or \n\n# !conda install -c conda-forge mlflow\n\n\n\n\nHere we are going to import a list of libraries that we need for this tutorial.\n\n!python --version\n\nPython 3.9.0\n\n\n\nfrom fastdownload import download_url\nfrom pathlib import Path\nimport pandas as pd\n\nfrom sklearn.linear_model import Lasso, LinearRegression\nfrom sklearn.metrics import mean_squared_error \n\nimport mlflow\nfrom mlflow.models.signature import infer_signature\n\n\n\n\nBefore starting any training or data preprocessing, we start by setting tracking uri and experiment for this mlflow experiment. Tracking uri can be\n- localhost\n- localhost with SQlite\n- localhost with tracking server\n- remote tracking server, backend and artifact stores\nIn this tutorial, we will start with localhost option and we will also use remote tracking server option in the second half of this tutorial.\n\n\n\nIn a localhost setting, the backend and artifact store share a local folder called ./mlruns.\n\nmlflow.set_tracking_uri(\"mlruns/\")\nmlflow.set_experiment(\"Experiment-1\")\n\n&lt;Experiment: artifact_location='/home/shane/mlops-practice/experiment-tracking/mlruns/146920015920581846', creation_time=1689589700627, experiment_id='146920015920581846', last_update_time=1689589700627, lifecycle_stage='active', name='Experiment-1', tags={}&gt;\n\n\nmlflow.set_experiment() is for setting the experiment name and we can see that a new experiment is created.\n\n!tree .\n\n.\n├── data\n│   ├── green_tripdata_2023-01.parquet\n│   └── green_tripdata_2023-02.parquet\n├── env.yaml\n├── experiment_tracking.html\n├── experiment_tracking.ipynb\n├── experiment_tracking.qmd\n├── experiment_tracking_files\n│   └── libs\n│       ├── bootstrap\n│       │   ├── bootstrap-icons.css\n│       │   ├── bootstrap-icons.woff\n│       │   ├── bootstrap.min.css\n│       │   └── bootstrap.min.js\n│       ├── clipboard\n│       │   └── clipboard.min.js\n│       └── quarto-html\n│           ├── anchor.min.js\n│           ├── popper.min.js\n│           ├── quarto-syntax-highlighting.css\n│           ├── quarto.js\n│           ├── tippy.css\n│           └── tippy.umd.min.js\n├── imgs\n│   ├── mlflow_run1.png\n│   ├── mlflow_ui.png\n│   ├── model.png\n│   └── run1_metadata.png\n└── mlruns\n    ├── 0\n    │   └── meta.yaml\n    ├── 146920015920581846\n    │   ├── 640f197c41044eb58e684d1967611220\n    │   │   ├── artifacts\n    │   │   │   └── model\n    │   │   │       ├── MLmodel\n    │   │   │       ├── conda.yaml\n    │   │   │       ├── model.pkl\n    │   │   │       ├── python_env.yaml\n    │   │   │       └── requirements.txt\n    │   │   ├── meta.yaml\n    │   │   ├── metrics\n    │   │   │   └── RMSE\n    │   │   ├── params\n    │   │   │   ├── Train-data-path\n    │   │   │   └── Valid-data-path\n    │   │   └── tags\n    │   │       ├── Developer\n    │   │       ├── mlflow.log-model.history\n    │   │       ├── mlflow.runName\n    │   │       ├── mlflow.source.name\n    │   │       ├── mlflow.source.type\n    │   │       └── mlflow.user\n    │   ├── 830a1dba067e437abf9569d4b2481d7c\n    │   │   ├── artifacts\n    │   │   │   └── model\n    │   │   │       ├── MLmodel\n    │   │   │       ├── conda.yaml\n    │   │   │       ├── model.pkl\n    │   │   │       ├── python_env.yaml\n    │   │   │       └── requirements.txt\n    │   │   ├── meta.yaml\n    │   │   ├── metrics\n    │   │   │   └── RMSE\n    │   │   ├── params\n    │   │   │   ├── Train-data-path\n    │   │   │   └── Valid-data-path\n    │   │   └── tags\n    │   │       ├── Developer\n    │   │       ├── mlflow.log-model.history\n    │   │       ├── mlflow.runName\n    │   │       ├── mlflow.source.name\n    │   │       ├── mlflow.source.type\n    │   │       └── mlflow.user\n    │   └── meta.yaml\n    └── models\n        └── nyc-taxi-regressor\n            ├── meta.yaml\n            └── version-1\n                └── meta.yaml\n\n25 directories, 55 files\n\n\nWe can run mlflow ui in terminal to access, well, mlflow ui.\n:\n\n\n\nThe dataset that we are using for this tutorial is NYC TLC Trip Record dataset.\nWe are going to predict duration of a taxi ride.\n\ndata_path = Path('data')\nif not data_path.exists():\n    data_path.mkdir(exist_ok=True)\n\nFirst, we are creating a data folder data to which we are going to download the datasets.\n\ndef download_data(year : int, month : int, data_path : Path) -&gt; None:\n    '''download nyc green taxi data in parquet form and save it in data_path'''\n    url = f\"https://d37ci6vzurychx.cloudfront.net/trip-data/green_tripdata_{year}-{month:0&gt;2}.parquet\"\n    download_url(url, dest=data_path, show_progress=True)\n\ndownload_data(2023, 1, data_path)\ndownload_data(2023, 2, data_path)\n\n\n\n\n\n\n    \n      \n      100.46% [1433600/1427002 00:01&lt;00:00]\n    \n    \n\n\n\n\n\n\n\n    \n      \n      100.41% [1540096/1533740 00:01&lt;00:00]\n    \n    \n\n\nQuick side note for pyformatting,\n\nmonth = 2\nprint(f\"month == {month} : {month:0&gt;2}\")\n\nmonth = 11\nprint(f\"month == {month} : {month:0&gt;2}\")\n\nmonth == 2 : 02\nmonth == 11 : 11\n\n\n\n!tree .\n\n.\n├── data\n│   ├── green_tripdata_2023-01.parquet\n│   └── green_tripdata_2023-02.parquet\n├── env.yaml\n├── experiment_tracking.html\n├── experiment_tracking.ipynb\n├── experiment_tracking.qmd\n├── experiment_tracking_files\n│   └── libs\n│       ├── bootstrap\n│       │   ├── bootstrap-icons.css\n│       │   ├── bootstrap-icons.woff\n│       │   ├── bootstrap.min.css\n│       │   └── bootstrap.min.js\n│       ├── clipboard\n│       │   └── clipboard.min.js\n│       └── quarto-html\n│           ├── anchor.min.js\n│           ├── popper.min.js\n│           ├── quarto-syntax-highlighting.css\n│           ├── quarto.js\n│           ├── tippy.css\n│           └── tippy.umd.min.js\n├── imgs\n│   ├── mlflow_run1.png\n│   ├── mlflow_ui.png\n│   ├── model.png\n│   └── run1_metadata.png\n└── mlruns\n    ├── 0\n    │   └── meta.yaml\n    ├── 146920015920581846\n    │   ├── 640f197c41044eb58e684d1967611220\n    │   │   ├── artifacts\n    │   │   │   └── model\n    │   │   │       ├── MLmodel\n    │   │   │       ├── conda.yaml\n    │   │   │       ├── model.pkl\n    │   │   │       ├── python_env.yaml\n    │   │   │       └── requirements.txt\n    │   │   ├── meta.yaml\n    │   │   ├── metrics\n    │   │   │   └── RMSE\n    │   │   ├── params\n    │   │   │   ├── Train-data-path\n    │   │   │   └── Valid-data-path\n    │   │   └── tags\n    │   │       ├── Developer\n    │   │       ├── mlflow.log-model.history\n    │   │       ├── mlflow.runName\n    │   │       ├── mlflow.source.name\n    │   │       ├── mlflow.source.type\n    │   │       └── mlflow.user\n    │   ├── 830a1dba067e437abf9569d4b2481d7c\n    │   │   ├── artifacts\n    │   │   │   └── model\n    │   │   │       ├── MLmodel\n    │   │   │       ├── conda.yaml\n    │   │   │       ├── model.pkl\n    │   │   │       ├── python_env.yaml\n    │   │   │       └── requirements.txt\n    │   │   ├── meta.yaml\n    │   │   ├── metrics\n    │   │   │   └── RMSE\n    │   │   ├── params\n    │   │   │   ├── Train-data-path\n    │   │   │   └── Valid-data-path\n    │   │   └── tags\n    │   │       ├── Developer\n    │   │       ├── mlflow.log-model.history\n    │   │       ├── mlflow.runName\n    │   │       ├── mlflow.source.name\n    │   │       ├── mlflow.source.type\n    │   │       └── mlflow.user\n    │   └── meta.yaml\n    └── models\n        └── nyc-taxi-regressor\n            ├── meta.yaml\n            └── version-1\n                └── meta.yaml\n\n25 directories, 55 files\n\n\nDatasets are downloaded using fastdownload library from fastai.\n\n\n\n\ndef read_dataframe(filename: Path)-&gt; pd.DataFrame:\n    df = pd.read_parquet(filename)\n    df[\"duration\"] = df[\"lpep_dropoff_datetime\"] - df[\"lpep_pickup_datetime\"]\n    df.duration = df[\"duration\"].apply(lambda td : td.total_seconds() / 60)\n    df = df[(df.duration  &gt;= 0) & (df.duration &lt;= 60) ]\n\n    categorical_data = [\"PULocationID\", \"DOLocationID\"]\n    df[categorical_data] = df[categorical_data].astype(str)\n    df[\"PU_DO\"] = df['PULocationID'] + \"_\" + df['DOLocationID']\n\n    return df\n\nSince the files are in parquet format, we use pd.read_parquet() method.\n\n# df[\"duration\"] = df[\"lpep_dropoff_datetime\"] - df[\"lpep_pickup_datetime\"]\n# df.duration = df[\"duration\"].apply(lambda td : td.total_seconds() / 60)\n\nWe want to calculate the duration of each trip. The trip duration is calculated by subtracting pickup datetime from dropoff datetime.\nWe also want to get the duration in minute. We get the total seconds and divided by 60.\n\ndf = read_dataframe(\"data/green_tripdata_2023-01.parquet\")\ndf_val = read_dataframe(\"data/green_tripdata_2023-02.parquet\")\n\n\ndef preprocess(df : pd.DataFrame) -&gt; tuple((pd.DataFrame, pd.DataFrame)):\n    categorical = [\"PU_DO\"]\n    numerical   = [\"trip_distance\", \"fare_amount\", \"total_amount\"]\n\n    X = df[categorical + numerical]\n    y = df.duration\n\n    return X, y\n    \n\n\nX, y = preprocess(df)\nX_val, y_val = preprocess(df_val)\n\nAfter loading train and validation dataset and performing preprocessing, we now have features X and targets y.\nNow we can start training the model.\n\n\n\n\ndef train(X, y):\n    model = LinearRegression()\n    model.fit(X,y)\n\n    return model\n\nWe will initialize mlflow run as\n\n# with mlflow.start_run() as run:\n\nand wrap up the training inside of it.\n\nset_tag : for tracking metadata\nlog_param : for logging parameters\nlog_metric : for logging metric\n\nIn the example below, we use set_tag for tracking developer name, log_param for tracking data folder used for training and validation ,and log_metric for tracking validation rmse metric.\nSome other useful methods are : - set_tags : Log a batch of tags for the current run. - log_params : Log a batch of params for the current run. - log_artifact : Log a local file or directory as an artifact of the currently active run. - log_artifacts : Log all the contents of a local directory as artifacts of the run\n\nwith mlflow.start_run() as run:\n\n    mlflow.set_tag(\"Developer\", \"Shane\")\n    mlflow.log_param(\"Train-data-path\", \"data/green_tripdata_2023-01.parquet\")\n    mlflow.log_param(\"Valid-data-path\", \"data/green_tripdata_2023-02.parquet\")\n    \n    model = train(X, y)\n\n    preds = model.predict(X_val)\n\n    rmse = mean_squared_error(y_val, preds, squared=False)\n\n    mlflow.log_metric('RMSE', rmse)\n    signature = infer_signature(X_val, preds)\n    model_uri = mlflow.sklearn.log_model(model, artifact_path=\"model\", signature=signature).model_uri\n   \n\n\n\n\nfist run\n\n\nThe first run can be seen in the above picture with the name, shivering-panda-266. It is a random run name since we didn’t set a specific run name.\n\n\n\nrun1\n\n\nWe can see the Train-data-path, Valid-data-path in the Parameters section, RMSE in metrics section and Developer in the Tags section.\n\n\n\n\n# signature = infer_signature(X_val, preds)\n# mlflow.sklearn.log_model(model, artifact_path=\"model\", signature=signature)\n\nModel signatures define input and output schemas for MLflow models. Model signature is obtained here using infer_signature.\nWe can log a model using mlflow.&lt;framework&gt;.log_model. In this case, we are using mlflow.sklearn.log_model.\n\n\n\nmodel1\n\n\nSince we add signature parameter, we can see the model input and output schema here. We can also see two ways that we can load the model and make predictions.\n\n\n\nWe can also do auto logging by using mlflow.&lt;framework&gt;.autolog()\n\n# mlflow.sklearn.autolog()\n\nAutologging is known to be compatible with the following package versions: 0.22.1 &lt;= scikit-learn &lt;= 1.2.2. Autologging may not succeed when used with package versions outside of this range.\n\n\n\nWe have saved the model using log_model. Now, we are going to load that model for prediction.\n\nfrom mlflow import MlflowClient\n\nclient = MlflowClient(tracking_uri=\"mlruns\")\n\n\nexperiments = client.search_experiments()\n\nfor experiment in experiments:\n    print(f\"Experiment Name : {experiment.name}\")\n    print(f\"\\tExperiment id :{experiment.experiment_id}\")\n    print(f\"\\tArtifact Location :{experiment.artifact_location}\\n\")\n\nExperiment Name : Experiment-1\n    Experiment id :146920015920581846\n    Artifact Location :/home/shane/mlops-practice/experiment-tracking/mlruns/146920015920581846\n\nExperiment Name : Default\n    Experiment id :0\n    Artifact Location :/home/shane/mlops-practice/experiment-tracking/mlruns/0\n\n\n\nOur experiment’s name is “Experiment-1” and the Experiment id for that is “146920015920581846”.\n\nfor experiment in experiments:\n    if experiment.name == \"Experiment-1\":\n        exp = experiment\n\n\nexp_id = exp.experiment_id\nruns = client.search_runs(experiment_ids=[exp_id])\n\nfor run in runs:\n    print(f\"run name : {run.info.run_name}\")\n    print(f\"\\trun id : {run.info.run_id}\")\n    print(f\"\\trmse : {run.data.metrics['RMSE']}\")\n\nrun name : popular-shoat-727\n    run id : 67b114b678e04115983aaafaa7b2294f\n    rmse : 6.282692349434918\nrun name : redolent-rat-378\n    run id : 640f197c41044eb58e684d1967611220\n    rmse : 6.282692349434918\nrun name : silent-moose-167\n    run id : 830a1dba067e437abf9569d4b2481d7c\n    rmse : 6.282692349434918\n\n\nLet’s pick a run_id of the model that we want to load.\n\nrun_id = runs[0].info.run_id\nlogged_model = f'runs:/{run_id}/model'\n\n# Load model as a PyFuncModel.\nloaded_model = mlflow.pyfunc.load_model(logged_model)\n\n# Predict on a Pandas DataFrame.\nimport pandas as pd\nloaded_model.predict(X_val)\n\n2023/07/17 18:28:40 WARNING mlflow.pyfunc: Detected one or more mismatches between the model's dependencies and the current Python environment:\n - mlflow (current: 2.4.2, required: mlflow==2.4)\nTo fix the mismatches, call `mlflow.pyfunc.get_model_dependencies(model_uri)` to fetch the model's environment and install dependencies using the resulting environment file.\n\n\narray([26.09040939, 16.31353026, 22.14756441, ..., 15.42763737,\n       14.91915344, 12.24746033])\n\n\n\n\n\nModel Registry is a centralized model store, a set of APIs and UI. It provides\n    - model lineage, \n    - model versioning, \n    - stage transition, and \n    - annotations.\n\nmlflow.set_tracking_uri('mlruns/')\n\nmodel_uri = f\"runs:/{run_id}/models\"\nmlflow.register_model(model_uri=model_uri, name=\"nyc-taxi-regressor\")\n\nRegistered model 'nyc-taxi-regressor' already exists. Creating a new version of this model...\n2023/07/17 18:28:48 INFO mlflow.tracking._model_registry.client: Waiting up to 300 seconds for model version to finish creation. Model name: nyc-taxi-regressor, version 2\nCreated version '2' of model 'nyc-taxi-regressor'.\n\n\n&lt;ModelVersion: aliases=[], creation_timestamp=1689595128899, current_stage='None', description=None, last_updated_timestamp=1689595128899, name='nyc-taxi-regressor', run_id='67b114b678e04115983aaafaa7b2294f', run_link=None, source='/home/shane/mlops-practice/experiment-tracking/mlruns/146920015920581846/67b114b678e04115983aaafaa7b2294f/artifacts/models', status='READY', status_message=None, tags={}, user_id=None, version=2&gt;\n\n\nWe have now registered the model under the name of “nyc-taxi-regressor’.\nWe can see that the version of the model is now 1. Since this is the first model registered under this name.\nBut It doesn’t have any staging information.\n\nmodel_name = \"nyc-taxi-regressor\"\nlatest_versions = client.get_latest_versions(name=model_name)\n\nfor version in latest_versions:\n    print(f\"version: {version.version}, stage: {version.current_stage}\")\n\nversion: 1, stage: Staging\nversion: 2, stage: None\n\n\nWe can transition the model version and stages using transition_model_version_stage.\n\nmodel_version = 1\nnew_stage = \"Staging\"\nclient.transition_model_version_stage(\n    name=model_name,\n    version=model_version,\n    stage=new_stage,\n    archive_existing_versions=False\n)\n\n&lt;ModelVersion: aliases=[], creation_timestamp=1689590172405, current_stage='Staging', description=None, last_updated_timestamp=1689595133542, name='nyc-taxi-regressor', run_id='640f197c41044eb58e684d1967611220', run_link=None, source='/home/shane/mlops-practice/experiment-tracking/mlruns/146920015920581846/640f197c41044eb58e684d1967611220/artifacts/models', status='READY', status_message=None, tags={}, user_id=None, version=1&gt;\n\n\n\nmodel_name = \"nyc-taxi-regressor\"\nlatest_versions = client.get_latest_versions(name=model_name)\n\nfor version in latest_versions:\n    print(f\"version: {version.version}, stage: {version.current_stage}\")\n\nversion: 1, stage: Staging\nversion: 2, stage: None\n\n\nNow, we can see that the stage of the model is now Staging.\n\nfrom datetime import datetime\n\ndate = datetime.today().date()\nclient.update_model_version(\n    name=model_name,\n    version=model_version,\n    description=f\"The model version {model_version} was transitioned to {new_stage} on {date}\"\n)\n\n&lt;ModelVersion: aliases=[], creation_timestamp=1689590172405, current_stage='Staging', description='The model version 1 was transitioned to Staging on 2023-07-17', last_updated_timestamp=1689595137551, name='nyc-taxi-regressor', run_id='640f197c41044eb58e684d1967611220', run_link=None, source='/home/shane/mlops-practice/experiment-tracking/mlruns/146920015920581846/640f197c41044eb58e684d1967611220/artifacts/models', status='READY', status_message=None, tags={}, user_id=None, version=1&gt;\n\n\nWe could also add description of the models like datetime information above."
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#install",
    "href": "posts/mlflow/experiment_tracking.html#install",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "We can install mlflow using pip or conda.\n\n# !pip install mlflow \n\n# or \n\n# !conda install -c conda-forge mlflow"
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#imports",
    "href": "posts/mlflow/experiment_tracking.html#imports",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "Here we are going to import a list of libraries that we need for this tutorial.\n\n!python --version\n\nPython 3.9.0\n\n\n\nfrom fastdownload import download_url\nfrom pathlib import Path\nimport pandas as pd\n\nfrom sklearn.linear_model import Lasso, LinearRegression\nfrom sklearn.metrics import mean_squared_error \n\nimport mlflow\nfrom mlflow.models.signature import infer_signature"
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#tracking-uri",
    "href": "posts/mlflow/experiment_tracking.html#tracking-uri",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "Before starting any training or data preprocessing, we start by setting tracking uri and experiment for this mlflow experiment. Tracking uri can be\n- localhost\n- localhost with SQlite\n- localhost with tracking server\n- remote tracking server, backend and artifact stores\nIn this tutorial, we will start with localhost option and we will also use remote tracking server option in the second half of this tutorial."
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#localhost",
    "href": "posts/mlflow/experiment_tracking.html#localhost",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "In a localhost setting, the backend and artifact store share a local folder called ./mlruns.\n\nmlflow.set_tracking_uri(\"mlruns/\")\nmlflow.set_experiment(\"Experiment-1\")\n\n&lt;Experiment: artifact_location='/home/shane/mlops-practice/experiment-tracking/mlruns/146920015920581846', creation_time=1689589700627, experiment_id='146920015920581846', last_update_time=1689589700627, lifecycle_stage='active', name='Experiment-1', tags={}&gt;\n\n\nmlflow.set_experiment() is for setting the experiment name and we can see that a new experiment is created.\n\n!tree .\n\n.\n├── data\n│   ├── green_tripdata_2023-01.parquet\n│   └── green_tripdata_2023-02.parquet\n├── env.yaml\n├── experiment_tracking.html\n├── experiment_tracking.ipynb\n├── experiment_tracking.qmd\n├── experiment_tracking_files\n│   └── libs\n│       ├── bootstrap\n│       │   ├── bootstrap-icons.css\n│       │   ├── bootstrap-icons.woff\n│       │   ├── bootstrap.min.css\n│       │   └── bootstrap.min.js\n│       ├── clipboard\n│       │   └── clipboard.min.js\n│       └── quarto-html\n│           ├── anchor.min.js\n│           ├── popper.min.js\n│           ├── quarto-syntax-highlighting.css\n│           ├── quarto.js\n│           ├── tippy.css\n│           └── tippy.umd.min.js\n├── imgs\n│   ├── mlflow_run1.png\n│   ├── mlflow_ui.png\n│   ├── model.png\n│   └── run1_metadata.png\n└── mlruns\n    ├── 0\n    │   └── meta.yaml\n    ├── 146920015920581846\n    │   ├── 640f197c41044eb58e684d1967611220\n    │   │   ├── artifacts\n    │   │   │   └── model\n    │   │   │       ├── MLmodel\n    │   │   │       ├── conda.yaml\n    │   │   │       ├── model.pkl\n    │   │   │       ├── python_env.yaml\n    │   │   │       └── requirements.txt\n    │   │   ├── meta.yaml\n    │   │   ├── metrics\n    │   │   │   └── RMSE\n    │   │   ├── params\n    │   │   │   ├── Train-data-path\n    │   │   │   └── Valid-data-path\n    │   │   └── tags\n    │   │       ├── Developer\n    │   │       ├── mlflow.log-model.history\n    │   │       ├── mlflow.runName\n    │   │       ├── mlflow.source.name\n    │   │       ├── mlflow.source.type\n    │   │       └── mlflow.user\n    │   ├── 830a1dba067e437abf9569d4b2481d7c\n    │   │   ├── artifacts\n    │   │   │   └── model\n    │   │   │       ├── MLmodel\n    │   │   │       ├── conda.yaml\n    │   │   │       ├── model.pkl\n    │   │   │       ├── python_env.yaml\n    │   │   │       └── requirements.txt\n    │   │   ├── meta.yaml\n    │   │   ├── metrics\n    │   │   │   └── RMSE\n    │   │   ├── params\n    │   │   │   ├── Train-data-path\n    │   │   │   └── Valid-data-path\n    │   │   └── tags\n    │   │       ├── Developer\n    │   │       ├── mlflow.log-model.history\n    │   │       ├── mlflow.runName\n    │   │       ├── mlflow.source.name\n    │   │       ├── mlflow.source.type\n    │   │       └── mlflow.user\n    │   └── meta.yaml\n    └── models\n        └── nyc-taxi-regressor\n            ├── meta.yaml\n            └── version-1\n                └── meta.yaml\n\n25 directories, 55 files\n\n\nWe can run mlflow ui in terminal to access, well, mlflow ui.\n:"
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#downloading-dataset",
    "href": "posts/mlflow/experiment_tracking.html#downloading-dataset",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "The dataset that we are using for this tutorial is NYC TLC Trip Record dataset.\nWe are going to predict duration of a taxi ride.\n\ndata_path = Path('data')\nif not data_path.exists():\n    data_path.mkdir(exist_ok=True)\n\nFirst, we are creating a data folder data to which we are going to download the datasets.\n\ndef download_data(year : int, month : int, data_path : Path) -&gt; None:\n    '''download nyc green taxi data in parquet form and save it in data_path'''\n    url = f\"https://d37ci6vzurychx.cloudfront.net/trip-data/green_tripdata_{year}-{month:0&gt;2}.parquet\"\n    download_url(url, dest=data_path, show_progress=True)\n\ndownload_data(2023, 1, data_path)\ndownload_data(2023, 2, data_path)\n\n\n\n\n\n\n    \n      \n      100.46% [1433600/1427002 00:01&lt;00:00]\n    \n    \n\n\n\n\n\n\n\n    \n      \n      100.41% [1540096/1533740 00:01&lt;00:00]\n    \n    \n\n\nQuick side note for pyformatting,\n\nmonth = 2\nprint(f\"month == {month} : {month:0&gt;2}\")\n\nmonth = 11\nprint(f\"month == {month} : {month:0&gt;2}\")\n\nmonth == 2 : 02\nmonth == 11 : 11\n\n\n\n!tree .\n\n.\n├── data\n│   ├── green_tripdata_2023-01.parquet\n│   └── green_tripdata_2023-02.parquet\n├── env.yaml\n├── experiment_tracking.html\n├── experiment_tracking.ipynb\n├── experiment_tracking.qmd\n├── experiment_tracking_files\n│   └── libs\n│       ├── bootstrap\n│       │   ├── bootstrap-icons.css\n│       │   ├── bootstrap-icons.woff\n│       │   ├── bootstrap.min.css\n│       │   └── bootstrap.min.js\n│       ├── clipboard\n│       │   └── clipboard.min.js\n│       └── quarto-html\n│           ├── anchor.min.js\n│           ├── popper.min.js\n│           ├── quarto-syntax-highlighting.css\n│           ├── quarto.js\n│           ├── tippy.css\n│           └── tippy.umd.min.js\n├── imgs\n│   ├── mlflow_run1.png\n│   ├── mlflow_ui.png\n│   ├── model.png\n│   └── run1_metadata.png\n└── mlruns\n    ├── 0\n    │   └── meta.yaml\n    ├── 146920015920581846\n    │   ├── 640f197c41044eb58e684d1967611220\n    │   │   ├── artifacts\n    │   │   │   └── model\n    │   │   │       ├── MLmodel\n    │   │   │       ├── conda.yaml\n    │   │   │       ├── model.pkl\n    │   │   │       ├── python_env.yaml\n    │   │   │       └── requirements.txt\n    │   │   ├── meta.yaml\n    │   │   ├── metrics\n    │   │   │   └── RMSE\n    │   │   ├── params\n    │   │   │   ├── Train-data-path\n    │   │   │   └── Valid-data-path\n    │   │   └── tags\n    │   │       ├── Developer\n    │   │       ├── mlflow.log-model.history\n    │   │       ├── mlflow.runName\n    │   │       ├── mlflow.source.name\n    │   │       ├── mlflow.source.type\n    │   │       └── mlflow.user\n    │   ├── 830a1dba067e437abf9569d4b2481d7c\n    │   │   ├── artifacts\n    │   │   │   └── model\n    │   │   │       ├── MLmodel\n    │   │   │       ├── conda.yaml\n    │   │   │       ├── model.pkl\n    │   │   │       ├── python_env.yaml\n    │   │   │       └── requirements.txt\n    │   │   ├── meta.yaml\n    │   │   ├── metrics\n    │   │   │   └── RMSE\n    │   │   ├── params\n    │   │   │   ├── Train-data-path\n    │   │   │   └── Valid-data-path\n    │   │   └── tags\n    │   │       ├── Developer\n    │   │       ├── mlflow.log-model.history\n    │   │       ├── mlflow.runName\n    │   │       ├── mlflow.source.name\n    │   │       ├── mlflow.source.type\n    │   │       └── mlflow.user\n    │   └── meta.yaml\n    └── models\n        └── nyc-taxi-regressor\n            ├── meta.yaml\n            └── version-1\n                └── meta.yaml\n\n25 directories, 55 files\n\n\nDatasets are downloaded using fastdownload library from fastai."
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#preprocessing",
    "href": "posts/mlflow/experiment_tracking.html#preprocessing",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "def read_dataframe(filename: Path)-&gt; pd.DataFrame:\n    df = pd.read_parquet(filename)\n    df[\"duration\"] = df[\"lpep_dropoff_datetime\"] - df[\"lpep_pickup_datetime\"]\n    df.duration = df[\"duration\"].apply(lambda td : td.total_seconds() / 60)\n    df = df[(df.duration  &gt;= 0) & (df.duration &lt;= 60) ]\n\n    categorical_data = [\"PULocationID\", \"DOLocationID\"]\n    df[categorical_data] = df[categorical_data].astype(str)\n    df[\"PU_DO\"] = df['PULocationID'] + \"_\" + df['DOLocationID']\n\n    return df\n\nSince the files are in parquet format, we use pd.read_parquet() method.\n\n# df[\"duration\"] = df[\"lpep_dropoff_datetime\"] - df[\"lpep_pickup_datetime\"]\n# df.duration = df[\"duration\"].apply(lambda td : td.total_seconds() / 60)\n\nWe want to calculate the duration of each trip. The trip duration is calculated by subtracting pickup datetime from dropoff datetime.\nWe also want to get the duration in minute. We get the total seconds and divided by 60.\n\ndf = read_dataframe(\"data/green_tripdata_2023-01.parquet\")\ndf_val = read_dataframe(\"data/green_tripdata_2023-02.parquet\")\n\n\ndef preprocess(df : pd.DataFrame) -&gt; tuple((pd.DataFrame, pd.DataFrame)):\n    categorical = [\"PU_DO\"]\n    numerical   = [\"trip_distance\", \"fare_amount\", \"total_amount\"]\n\n    X = df[categorical + numerical]\n    y = df.duration\n\n    return X, y\n    \n\n\nX, y = preprocess(df)\nX_val, y_val = preprocess(df_val)\n\nAfter loading train and validation dataset and performing preprocessing, we now have features X and targets y.\nNow we can start training the model."
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#model-training",
    "href": "posts/mlflow/experiment_tracking.html#model-training",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "def train(X, y):\n    model = LinearRegression()\n    model.fit(X,y)\n\n    return model\n\nWe will initialize mlflow run as\n\n# with mlflow.start_run() as run:\n\nand wrap up the training inside of it.\n\nset_tag : for tracking metadata\nlog_param : for logging parameters\nlog_metric : for logging metric\n\nIn the example below, we use set_tag for tracking developer name, log_param for tracking data folder used for training and validation ,and log_metric for tracking validation rmse metric.\nSome other useful methods are : - set_tags : Log a batch of tags for the current run. - log_params : Log a batch of params for the current run. - log_artifact : Log a local file or directory as an artifact of the currently active run. - log_artifacts : Log all the contents of a local directory as artifacts of the run\n\nwith mlflow.start_run() as run:\n\n    mlflow.set_tag(\"Developer\", \"Shane\")\n    mlflow.log_param(\"Train-data-path\", \"data/green_tripdata_2023-01.parquet\")\n    mlflow.log_param(\"Valid-data-path\", \"data/green_tripdata_2023-02.parquet\")\n    \n    model = train(X, y)\n\n    preds = model.predict(X_val)\n\n    rmse = mean_squared_error(y_val, preds, squared=False)\n\n    mlflow.log_metric('RMSE', rmse)\n    signature = infer_signature(X_val, preds)\n    model_uri = mlflow.sklearn.log_model(model, artifact_path=\"model\", signature=signature).model_uri\n   \n\n\n\n\nfist run\n\n\nThe first run can be seen in the above picture with the name, shivering-panda-266. It is a random run name since we didn’t set a specific run name.\n\n\n\nrun1\n\n\nWe can see the Train-data-path, Valid-data-path in the Parameters section, RMSE in metrics section and Developer in the Tags section."
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#model-saving",
    "href": "posts/mlflow/experiment_tracking.html#model-saving",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "# signature = infer_signature(X_val, preds)\n# mlflow.sklearn.log_model(model, artifact_path=\"model\", signature=signature)\n\nModel signatures define input and output schemas for MLflow models. Model signature is obtained here using infer_signature.\nWe can log a model using mlflow.&lt;framework&gt;.log_model. In this case, we are using mlflow.sklearn.log_model.\n\n\n\nmodel1\n\n\nSince we add signature parameter, we can see the model input and output schema here. We can also see two ways that we can load the model and make predictions."
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#auto-logging",
    "href": "posts/mlflow/experiment_tracking.html#auto-logging",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "We can also do auto logging by using mlflow.&lt;framework&gt;.autolog()\n\n# mlflow.sklearn.autolog()\n\nAutologging is known to be compatible with the following package versions: 0.22.1 &lt;= scikit-learn &lt;= 1.2.2. Autologging may not succeed when used with package versions outside of this range."
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#model-loading",
    "href": "posts/mlflow/experiment_tracking.html#model-loading",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "We have saved the model using log_model. Now, we are going to load that model for prediction.\n\nfrom mlflow import MlflowClient\n\nclient = MlflowClient(tracking_uri=\"mlruns\")\n\n\nexperiments = client.search_experiments()\n\nfor experiment in experiments:\n    print(f\"Experiment Name : {experiment.name}\")\n    print(f\"\\tExperiment id :{experiment.experiment_id}\")\n    print(f\"\\tArtifact Location :{experiment.artifact_location}\\n\")\n\nExperiment Name : Experiment-1\n    Experiment id :146920015920581846\n    Artifact Location :/home/shane/mlops-practice/experiment-tracking/mlruns/146920015920581846\n\nExperiment Name : Default\n    Experiment id :0\n    Artifact Location :/home/shane/mlops-practice/experiment-tracking/mlruns/0\n\n\n\nOur experiment’s name is “Experiment-1” and the Experiment id for that is “146920015920581846”.\n\nfor experiment in experiments:\n    if experiment.name == \"Experiment-1\":\n        exp = experiment\n\n\nexp_id = exp.experiment_id\nruns = client.search_runs(experiment_ids=[exp_id])\n\nfor run in runs:\n    print(f\"run name : {run.info.run_name}\")\n    print(f\"\\trun id : {run.info.run_id}\")\n    print(f\"\\trmse : {run.data.metrics['RMSE']}\")\n\nrun name : popular-shoat-727\n    run id : 67b114b678e04115983aaafaa7b2294f\n    rmse : 6.282692349434918\nrun name : redolent-rat-378\n    run id : 640f197c41044eb58e684d1967611220\n    rmse : 6.282692349434918\nrun name : silent-moose-167\n    run id : 830a1dba067e437abf9569d4b2481d7c\n    rmse : 6.282692349434918\n\n\nLet’s pick a run_id of the model that we want to load.\n\nrun_id = runs[0].info.run_id\nlogged_model = f'runs:/{run_id}/model'\n\n# Load model as a PyFuncModel.\nloaded_model = mlflow.pyfunc.load_model(logged_model)\n\n# Predict on a Pandas DataFrame.\nimport pandas as pd\nloaded_model.predict(X_val)\n\n2023/07/17 18:28:40 WARNING mlflow.pyfunc: Detected one or more mismatches between the model's dependencies and the current Python environment:\n - mlflow (current: 2.4.2, required: mlflow==2.4)\nTo fix the mismatches, call `mlflow.pyfunc.get_model_dependencies(model_uri)` to fetch the model's environment and install dependencies using the resulting environment file.\n\n\narray([26.09040939, 16.31353026, 22.14756441, ..., 15.42763737,\n       14.91915344, 12.24746033])"
  },
  {
    "objectID": "posts/mlflow/experiment_tracking.html#model-registry",
    "href": "posts/mlflow/experiment_tracking.html#model-registry",
    "title": "Experiment Tracking with MLflow",
    "section": "",
    "text": "Model Registry is a centralized model store, a set of APIs and UI. It provides\n    - model lineage, \n    - model versioning, \n    - stage transition, and \n    - annotations.\n\nmlflow.set_tracking_uri('mlruns/')\n\nmodel_uri = f\"runs:/{run_id}/models\"\nmlflow.register_model(model_uri=model_uri, name=\"nyc-taxi-regressor\")\n\nRegistered model 'nyc-taxi-regressor' already exists. Creating a new version of this model...\n2023/07/17 18:28:48 INFO mlflow.tracking._model_registry.client: Waiting up to 300 seconds for model version to finish creation. Model name: nyc-taxi-regressor, version 2\nCreated version '2' of model 'nyc-taxi-regressor'.\n\n\n&lt;ModelVersion: aliases=[], creation_timestamp=1689595128899, current_stage='None', description=None, last_updated_timestamp=1689595128899, name='nyc-taxi-regressor', run_id='67b114b678e04115983aaafaa7b2294f', run_link=None, source='/home/shane/mlops-practice/experiment-tracking/mlruns/146920015920581846/67b114b678e04115983aaafaa7b2294f/artifacts/models', status='READY', status_message=None, tags={}, user_id=None, version=2&gt;\n\n\nWe have now registered the model under the name of “nyc-taxi-regressor’.\nWe can see that the version of the model is now 1. Since this is the first model registered under this name.\nBut It doesn’t have any staging information.\n\nmodel_name = \"nyc-taxi-regressor\"\nlatest_versions = client.get_latest_versions(name=model_name)\n\nfor version in latest_versions:\n    print(f\"version: {version.version}, stage: {version.current_stage}\")\n\nversion: 1, stage: Staging\nversion: 2, stage: None\n\n\nWe can transition the model version and stages using transition_model_version_stage.\n\nmodel_version = 1\nnew_stage = \"Staging\"\nclient.transition_model_version_stage(\n    name=model_name,\n    version=model_version,\n    stage=new_stage,\n    archive_existing_versions=False\n)\n\n&lt;ModelVersion: aliases=[], creation_timestamp=1689590172405, current_stage='Staging', description=None, last_updated_timestamp=1689595133542, name='nyc-taxi-regressor', run_id='640f197c41044eb58e684d1967611220', run_link=None, source='/home/shane/mlops-practice/experiment-tracking/mlruns/146920015920581846/640f197c41044eb58e684d1967611220/artifacts/models', status='READY', status_message=None, tags={}, user_id=None, version=1&gt;\n\n\n\nmodel_name = \"nyc-taxi-regressor\"\nlatest_versions = client.get_latest_versions(name=model_name)\n\nfor version in latest_versions:\n    print(f\"version: {version.version}, stage: {version.current_stage}\")\n\nversion: 1, stage: Staging\nversion: 2, stage: None\n\n\nNow, we can see that the stage of the model is now Staging.\n\nfrom datetime import datetime\n\ndate = datetime.today().date()\nclient.update_model_version(\n    name=model_name,\n    version=model_version,\n    description=f\"The model version {model_version} was transitioned to {new_stage} on {date}\"\n)\n\n&lt;ModelVersion: aliases=[], creation_timestamp=1689590172405, current_stage='Staging', description='The model version 1 was transitioned to Staging on 2023-07-17', last_updated_timestamp=1689595137551, name='nyc-taxi-regressor', run_id='640f197c41044eb58e684d1967611220', run_link=None, source='/home/shane/mlops-practice/experiment-tracking/mlruns/146920015920581846/640f197c41044eb58e684d1967611220/artifacts/models', status='READY', status_message=None, tags={}, user_id=None, version=1&gt;\n\n\nWe could also add description of the models like datetime information above."
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "About this blog"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "blog",
    "section": "",
    "text": "Experiment Tracking with MLflow\n\n\n\n\n\n\n\nmlops\n\n\nmlflow\n\n\n\n\n\n\n\n\n\n\n\nJul 17, 2023\n\n\nShane Ko Naung\n\n\n\n\n\n\nNo matching items"
  }
]